---
title: "ichimoku: The OANDA fxTrade API"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{ichimoku: The OANDA fxTrade API}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7, fig.height = 5
)
library(httptest)
start_vignette("oanda")
```

## About OANDA fxTrade

ichimoku contains an interface to the OANDA fxTrade API, creating a binding for the R language.

OANDA is an authoritative source of foreign exchange data used globally by governments and corporations alike. The API can be used for retrieving historical and live streaming price data for major currencies, metals, commodities, government bonds and stock indices.

This is considered a rich source of financial data with excellent availability, for instance daily OHLC pricing data for major forex pairs going back to the start of 2005, and data granularity ranging from 5 seconds to monthly.

Please note that 'OANDA' and 'fxTrade' are trademarks owned by OANDA Corporation, an entity which is entirely unaffiliated with the ichimoku package.

## Registering with OANDA

The OANDA fxTrade API, as distinct to other OANDA data sources such as its rates for business, is based upon their retail and professional trading offering. As such, access to the API requires an fxTrade account with OANDA and agreement to their API terms of use. Any account type is sufficient, including a 'demo' or 'practice' account, which at the time of writing is entirely free to sign up and use without limit.

For registering an account, the following URL may be used: <https://www.oanda.com/forex-trading/>.

After successful registration, a link can be found on your OANDA fxTrade account profile page 'Manage API Access' (My Account -> My Services -> Manage API Access). From there, a personal access token to use with the OANDA API can be generated, as well as revoked. This access token will enable all the OANDA functions in this package.

Note: this package only contains functions for retrieving available instruments and price data. It does not contain any code which implements any trading capability whatsoever. Hence using your access token with this package should be safe even for live accounts. However, the access token can be used (outside of this package) for all operations on your account including placing orders and trades. It is recommended therefore, for maximum security, that you sign up for a demo/practice account and use the access token for that account even if you hold an existing live account with OANDA.

## Setting your OANDA API Key

If the 'keyring' package is available on your machine, the OANDA API key (personal access token) can be set once and stored in your system keyring by using `oanda_set_key()`. This will enable it to be retrieved automatically for all subsequent sessions.

If an access token is revoked and re-generated, please remember to set the API key again through the `oanda_set_key()` function.

## The OANDA Functions

All of the OANDA functions in the package are prefixed by 'oanda' for clarity and ease of use.

### `oanda()`

Retrieve historical pricing data from the OANDA fxTrade API.

The arguments to the function are phrased identically to that of the API itself where relevant:

- `instrument` a string containing the base currency and quote currency delimited by a '_' (for example "USD_JPY"). Use the `oanda_instruments()` function to return a list of all valid instruments.
- `granularity` [default "D"] the granularity of the price data to fetch, one of "M", "W", "D", "H12", "H8", "H6", "H4", "H3", "H2", "H1", "M30", "M15", "M10", "M5", "M4", "M2", "M1", "S30", "S15", "S10", "S5".
- `count` (optional) the number of periods to return. The API supports a maximum of 5000 for each individual request, and defaults to 500 if not specified. 'count' should not be specified if both 'from' and 'to' arguments are provided, as the time range combined with 'granularity' will determine the number of periods to return.
- `from` (optional) the start of the time range for which to fetch price data, for example "2020-02-01".
- `to` (optional) the end of the time range for which to fetch price data, for example "2020-06-30".
- `price` [default "M"] the pricing component, one of "M" (midpoint), "B" (bid) or "A" (ask).
- `server` [default "practice"] select either the "practice" or "live" server depending on the account type held with OANDA.
- `apikey` (optional) string containing the OANDA fxTrade API key (personal access token). This argument is designed for specifying a function that returns such a string rather than the string itself, which could be potentially unsecure. This allows other packages that provide secure storage of secrets to be used if preferred over 'keyring'.

```{r oanda}
library(ichimoku)
oanda("USD_JPY", count = 3, from = "2010-11-01", price = "B", apikey = NULL)
```

The returned object is a dataframe with the following columns:
'time', 'open', 'high', 'low', 'close', 'volume' and 'complete'.

- **volume** should normally be disregarded as this reflects the trading volume registered by OANDA and may not be reflective of the broader market.

- **complete** indicates whether the data period is complete or not. If TRUE, the values are historical and not subject to change. If FALSE, the period is ongoing and the values reflect the current snapshot and the final values may or may not differ.

Important implementation notes:

- Incorporates automatic adjustment of the timestamps to end of period, as is customary for financial data. This means that, for example, today's pricing data (incomplete trading period) will have today's date as would be expected. In contrast, the raw data from the API has a timestamp of the start of the period.

- The API data sometimes includes data for non-trading days with very low volumes. This is more common for older data and less so with more recent data. These may represent OTC trades that occurred over the OANDA platform, but nevertheless do not reflect market rates. These are automatically excluded from the data returned as they would otherwise produce spurious results if used with `ichimoku()`.

For diagnostic purposes only, the parameter `.validate = FALSE` may be set to view the original data retrieved from the API without the automatic validation adjustments above. This parameter should not otherwise be set.

### `oanda_stream()`

Connect to the OANDA fxTrade streaming API and stream a list of prices generated by OANDA.

Requires a single argument, the 'instrument' to stream data for (please refer to `oanda()` above).

The 'server' and 'apikey' arguments are also available if required.

The streamed data is formatted for legibility, including the use of colour blocks in the console, but otherwise represents the raw data feed without omission.

The following should be noted from the streaming API documentation:

- Get a stream of Account Prices starting from when the request is made.
- This pricing stream does not include every single price created for the Account, but instead will provide at most 4 prices per second (every 250 milliseconds) for each instrument being requested.
- If more than one price is created for an instrument during the 250 millisecond window, only the price in effect at the end of the window is sent.
- This means that during periods of rapid price movement, subscribers to this stream will not be sent every price.
- Pricing windows for different connections to the price stream are not all aligned in the same way (i.e. they are not all aligned to the top of the second). This means that during periods of rapid price movement, different subscribers may observe different prices depending on their alignment.

### `oanda_chart()`

Create a live updating Ichimoku Kinko Hyo (cloud chart). The refresh rate can be set for the chart to be updated down to every second. A plot of the ichimoku chart for the price data requested is output to the graphical device at each refresh interval.

The arguments are identical to `oanda()` above with the addition of 'refresh' as the third argument to set the refresh rate of the chart in seconds, with a minimum of 1. 'from' and 'to' are also excluded as they are not relevant in this context.

If focus is not initially on the plot pane (in RStudio), please switch to it to view the chart.

Note that returned times are represented in UTC.

### `oanda_studio()`

Create an interactive session in an R Shiny app for working with dynamically-generated Ichimoku Kinko Hyo (cloud charts).

As all parameters may be set interactively in-app, the function can be launched as `oanda_studio()` without specifying any arguments. Otherwise, parameters may be set beforehand in the same way as `oanda_chart()`.

The use of this function provides a live analysis environment where parameters may be set interactively as required. The infotip provides ready access to the underlying data in a convenient manner.

The following additional parameters can be used to customise the behaviour of the Shiny app:

- `...` additional parameters passed along to the ‘options’ argument of `shiny::shinyApp()`.
- `launch.browser` [default TRUE] If TRUE, the system’s default web browser will be launched automatically after the app is started. The value of this argument can also be a function to call with the application’s URL. To use the default Shiny viewer in RStudio, please specify `getOption("shiny.launch.browser")`.

## Available Instruments

The list of financial instruments below serves as a reference only and may not be exhaustive and/or differ from those available for your account type or country/region.

The list of financial instruments available for your account may be retrieved by `oanda_instruments()`. The available instruments are also automatically populated as an input in `oanda_studio()`.


```{r instruments, echo=FALSE}
data.frame(
               stringsAsFactors = FALSE,
  name.....type.....displayName = c("AU200_AUD      CFD   Australia 200",
                                    "AUD_CAD CURRENCY         AUD/CAD",
                                    "AUD_CHF CURRENCY         AUD/CHF",
                                    "AUD_HKD CURRENCY         AUD/HKD","AUD_JPY CURRENCY         AUD/JPY",
                                    "AUD_NZD CURRENCY         AUD/NZD",
                                    "AUD_SGD CURRENCY         AUD/SGD",
                                    "AUD_USD CURRENCY         AUD/USD",
                                    "BCO_USD      CFD Brent Crude Oil",
                                    "CAD_CHF CURRENCY         CAD/CHF","CAD_HKD CURRENCY         CAD/HKD",
                                    "CAD_JPY CURRENCY         CAD/JPY",
                                    "CAD_SGD CURRENCY         CAD/SGD",
                                    "CHF_HKD CURRENCY         CHF/HKD",
                                    "CHF_JPY CURRENCY         CHF/JPY","CHF_ZAR CURRENCY         CHF/ZAR",
                                    "CN50_USD      CFD       China A50",
                                    "CORN_USD      CFD            Corn",
                                    "DE10YB_EUR      CFD            Bund",
                                    "DE30_EUR      CFD      Germany 30",
                                    "EU50_EUR      CFD       Europe 50",
                                    "EUR_AUD CURRENCY         EUR/AUD","EUR_CAD CURRENCY         EUR/CAD",
                                    "EUR_CHF CURRENCY         EUR/CHF",
                                    "EUR_CZK CURRENCY         EUR/CZK",
                                    "EUR_DKK CURRENCY         EUR/DKK",
                                    "EUR_GBP CURRENCY         EUR/GBP","EUR_HKD CURRENCY         EUR/HKD",
                                    "EUR_HUF CURRENCY         EUR/HUF",
                                    "EUR_JPY CURRENCY         EUR/JPY",
                                    "EUR_NOK CURRENCY         EUR/NOK",
                                    "EUR_NZD CURRENCY         EUR/NZD",
                                    "EUR_PLN CURRENCY         EUR/PLN","EUR_SEK CURRENCY         EUR/SEK",
                                    "EUR_SGD CURRENCY         EUR/SGD",
                                    "EUR_TRY CURRENCY         EUR/TRY",
                                    "EUR_USD CURRENCY         EUR/USD",
                                    "EUR_ZAR CURRENCY         EUR/ZAR","FR40_EUR      CFD       France 40",
                                    "GBP_AUD CURRENCY         GBP/AUD",
                                    "GBP_CAD CURRENCY         GBP/CAD",
                                    "GBP_CHF CURRENCY         GBP/CHF",
                                    "GBP_HKD CURRENCY         GBP/HKD",
                                    "GBP_JPY CURRENCY         GBP/JPY","GBP_NZD CURRENCY         GBP/NZD",
                                    "GBP_PLN CURRENCY         GBP/PLN",
                                    "GBP_SGD CURRENCY         GBP/SGD",
                                    "GBP_USD CURRENCY         GBP/USD",
                                    "GBP_ZAR CURRENCY         GBP/ZAR","HK33_HKD      CFD    Hong Kong 33",
                                    "HKD_JPY CURRENCY         HKD/JPY",
                                    "IN50_USD      CFD        India 50",
                                    "JP225_USD      CFD       Japan 225",
                                    "NAS100_USD      CFD      US Nas 100",
                                    "NATGAS_USD      CFD     Natural Gas",
                                    "NL25_EUR      CFD  Netherlands 25","NZD_CAD CURRENCY         NZD/CAD",
                                    "NZD_CHF CURRENCY         NZD/CHF",
                                    "NZD_HKD CURRENCY         NZD/HKD",
                                    "NZD_JPY CURRENCY         NZD/JPY",
                                    "NZD_SGD CURRENCY         NZD/SGD",
                                    "NZD_USD CURRENCY         NZD/USD","SG30_SGD      CFD    Singapore 30",
                                    "SGD_CHF CURRENCY         SGD/CHF",
                                    "SGD_JPY CURRENCY         SGD/JPY",
                                    "SOYBN_USD      CFD        Soybeans",
                                    "SPX500_USD      CFD      US SPX 500",
                                    "SUGAR_USD      CFD           Sugar","TRY_JPY CURRENCY         TRY/JPY",
                                    "TWIX_USD      CFD    Taiwan Index",
                                    "UK100_GBP      CFD          UK 100",
                                    "UK10YB_GBP      CFD     UK 10Y Gilt",
                                    "US2000_USD      CFD    US Russ 2000",
                                    "US30_USD      CFD   US Wall St 30",
                                    "USB02Y_USD      CFD    US 2Y T-Note",
                                    "USB05Y_USD      CFD    US 5Y T-Note","USB10Y_USD      CFD   US 10Y T-Note",
                                    "USB30Y_USD      CFD       US T-Bond",
                                    "USD_CAD CURRENCY         USD/CAD",
                                    "USD_CHF CURRENCY         USD/CHF",
                                    "USD_CNH CURRENCY         USD/CNH",
                                    "USD_CZK CURRENCY         USD/CZK","USD_DKK CURRENCY         USD/DKK",
                                    "USD_HKD CURRENCY         USD/HKD",
                                    "USD_HUF CURRENCY         USD/HUF",
                                    "USD_INR CURRENCY         USD/INR",
                                    "USD_JPY CURRENCY         USD/JPY","USD_MXN CURRENCY         USD/MXN",
                                    "USD_NOK CURRENCY         USD/NOK",
                                    "USD_PLN CURRENCY         USD/PLN",
                                    "USD_SEK CURRENCY         USD/SEK",
                                    "USD_SGD CURRENCY         USD/SGD",
                                    "USD_THB CURRENCY         USD/THB","USD_TRY CURRENCY         USD/TRY",
                                    "USD_ZAR CURRENCY         USD/ZAR",
                                    "WHEAT_USD      CFD           Wheat",
                                    "WTICO_USD      CFD  West Texas Oil",
                                    "XAG_AUD    METAL      Silver/AUD",
                                    "XAG_CAD    METAL      Silver/CAD","XAG_CHF    METAL      Silver/CHF",
                                    "XAG_EUR    METAL      Silver/EUR",
                                    "XAG_GBP    METAL      Silver/GBP",
                                    "XAG_HKD    METAL      Silver/HKD",
                                    "XAG_JPY    METAL      Silver/JPY","XAG_NZD    METAL      Silver/NZD",
                                    "XAG_SGD    METAL      Silver/SGD",
                                    "XAG_USD    METAL          Silver",
                                    "XAU_AUD    METAL        Gold/AUD",
                                    "XAU_CAD    METAL        Gold/CAD",
                                    "XAU_CHF    METAL        Gold/CHF","XAU_EUR    METAL        Gold/EUR",
                                    "XAU_GBP    METAL        Gold/GBP",
                                    "XAU_HKD    METAL        Gold/HKD",
                                    "XAU_JPY    METAL        Gold/JPY",
                                    "XAU_NZD    METAL        Gold/NZD","XAU_SGD    METAL        Gold/SGD",
                                    "XAU_USD    METAL            Gold",
                                    "XAU_XAG    METAL     Gold/Silver",
                                    "XCU_USD      CFD          Copper",
                                    "XPD_USD    METAL       Palladium",
                                    "XPT_USD    METAL        Platinum","ZAR_JPY CURRENCY         ZAR/JPY")
)
```



## Further Resources

Package website: https://shikokuchuo.net/ichimoku/

The most recent version of the package may be found at https://github.com/shikokuchuo/ichimoku/

```{r, include=FALSE}
end_vignette()
```

---
