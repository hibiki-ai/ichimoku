---
title: "ichimoku: The OANDA fxTrade API"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{ichimoku: The OANDA fxTrade API}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7, fig.height = 5
)

```

## About OANDA fxTrade

ichimoku contains an interface, or binding for the R language, to the OANDA fxTrade API.

OANDA is a primary source of foreign exchange data used by corporations and governments around the world. The API can be used for retrieving historical and live streaming price data for major currencies, metals, commodities, government bonds and stock indices.

As an example of the financial data that is available: OHLC pricing data can be obtained for major forex pairs from the start of 2005 with granularity ranging from 5 seconds to monthly. For the total list of over 120 covered instruments please refer to the [Available Instruments](#available-instruments) section below.

Please note that 'OANDA' and 'fxTrade' are trademarks owned by OANDA Corporation, an entity unaffiliated with the ichimoku package.

## Registering with OANDA

The OANDA fxTrade API, as distinct to other OANDA data sources, is based upon its retail and professional trading offering of the same name. As such, access to the API requires an fxTrade account with OANDA and agreement to their API terms of use. 

Registering for a 'demo' or 'practice' account is entirely free at the time of writing and provides full access to the API. For registering an account, the following URL may be used: <https://www.oanda.com/forex-trading/>.

After successful registration, a link can be found on your OANDA fxTrade account profile page 'Manage API Access' (My Account -> My Services -> Manage API Access). From there, a personal access token to use with the OANDA API can be generated, as well as revoked. This access token will enable all the OANDA functions in this package.

## Setting your OANDA API Key

If the 'keyring' package is installed, the OANDA API key (personal access token) can be set once and saved in your system credential store by using `oanda_set_key()`. This will enable it to be retrieved automatically for all subsequent sessions.

Separate keys can be set for practice and live accounts; please choose the correct account type when prompted.

If an access token is revoked and re-generated, please remember to set the API key again through the `oanda_set_key()` function.

## Using a Live Account

If you are using an access token for a live (real money) account, you will want to call `oanda_switch()` at the beginning of each session; this switches the default server from the practice server to the live server. Settings will only persist until the end of the session.

```{r oandaswitch}
library(ichimoku)

oanda_switch()
```

Note: this package only contains functions for retrieving available instruments and price data. It does not contain code to implement any trading capability whatsoever. Please be aware however, that a personal access token can be used (outside of this package) for all operations on your account including placing orders and trades, and appropriate precautions should be taken when using your live account token.

## The OANDA Functions

All of the OANDA functions in the package are prefixed by 'oanda' for clarity.

Functions may be called interactively without any arguments, e.g. `oanda_stream()` or `oanda_view()`, in which case you will be further prompted to enter required arguments; as opposed to when specifying such arguments normally, these should be entered unquoted i.e. without any surrounding "".

For all functions, the 'instrument' argument is case-insensitive and the delimiter can be either '_' or '-', such that both `oanda("USD_JPY")` and `oanda("usd-jpy")` would be acceptable.

### `oanda()`

Retrieve pricing data from the OANDA fxTrade API.

The arguments to the function are phrased identically to that of the API itself where relevant:

- `instrument` string containing the base currency and quote currency delimited by '_' or '-' (e.g. "USD_JPY" or "usd-jpy"). Use the `oanda_instruments()` function to return a list of all valid instruments
- `granularity` [default "D"] the granularity of the price data to fetch, one of "M", "W", "D", "H12", "H8", "H6", "H4", "H3", "H2", "H1", "M30", "M15", "M10", "M5", "M4", "M2", "M1", "S30", "S15", "S10", "S5"
- `count` (optional) the number of periods to return. The API supports a maximum of 5000 for each individual request, and defaults to 500 if not specified. If both 'from' and 'to' are specified, 'count' is ignored, as the time range combined with 'granularity' will determine the number of periods to return
- `from` (optional) the start of the time range for which to fetch price data, for example "2020-02-01"
- `to` (optional) the end of the time range for which to fetch price data, for example "2020-06-30"
- `price` [default "M"] the pricing component, one of "M" (midpoint), "B" (bid) or "A" (ask)
- `server` (optional) Specify the "practice" or "live" server according to the account type held with OANDA. If not specified, will default to "practice", unless this has been changed by `oanda_switch()`.
- `apikey` (optional) string containing the OANDA fxTrade API key (personal access token). Does not need to be specified if already stored by `oanda_set_key()`. This argument is designed for specifying a function that returns such a string rather than the string itself, which could be potentially unsecure. This allows other packages that provide secure storage of secrets to be used if preferred over 'keyring'
- `quietly` if set to TRUE, will suppress printing of output to the console and return quietly

Note: if both `from` and `to` are specified and the request would result in over 5000 periods being returned, the function prompts the user to confirm if multiple requests should be submitted. Unless the user response is "n" or "no", the data will proceed to be downloaded with rate limiting in place, and merged together into a single dataframe. The function is safe for use in non-interactive settings as in such cases the download will proceed automatically without prompting.

```{r oanda, eval=FALSE}
oanda("USD_JPY", count = 3, from = "2010-11-01", price = "B")
#>                  time   open   high    low  close volume complete
#> 1 2010-11-01 21:00:00 80.275 81.504 80.225 80.501  22291     TRUE
#> 2 2010-11-02 21:00:00 80.504 80.956 80.460 80.617  13795     TRUE
#> 3 2010-11-03 21:00:00 80.632 81.585 80.594 81.069  22204     TRUE
```

The returned object is a dataframe with the following columns:
'time', 'open', 'high', 'low', 'close', 'volume' and 'complete'.

- **volume** should be used with caution as this reflects the trading volume registered by OANDA and may not be reflective of the broader market

- **complete** indicates whether the data period is complete or not. If TRUE, the values are historical and not subject to change. If FALSE, the period is ongoing and the values reflect the current snapshot whilst final values may or may not differ

Important implementation notes:

- Incorporates automatic adjustment of the timestamps to end of period, as is customary for financial data. This means that, for example, today's pricing data (incomplete trading period) will have today's date as would be expected. In contrast, the raw data from the API has a timestamp of the start of the period

- The API data sometimes includes data for non-trading days with very low volumes. This is more common for older data and less so with more recent data. These may represent OTC trades that occurred over the OANDA platform, but nevertheless do not reflect market rates. These are automatically excluded from the data returned as they would otherwise produce spurious results used with `ichimoku()`

### `oanda_chart()`

Create an updating real-time Ichimoku cloud chart. The refresh rate can be set for the chart to be updated down to every second. A plot of the ichimoku chart for the price data requested is output to the graphical device at each refresh interval.

The arguments are identical to `oanda()` above with the addition of:

- `refresh` [default 5] set the refresh rate of the chart in seconds, with a minimum of 1
- `limit` (optional) specify a time in minutes by which to limit the session. The session will end with data returned automatically after the specified time has elapsed
- `...` additional parameters passed onto `ichimoku()` for calculating the ichimoku cloud or `autoplot()` to set chart parameters
- `periods` [default c(9L, 26L, 52L)] a vector defining the length of periods used for the cloud. This parameter should not normally be modified as using other values would be invalid in the context of traditional Ichimoku analysis

The arguments 'from' and 'to' are excluded as they are not relevant in this context.

```{r oandac, eval=FALSE}
# For a live Palladium price chart:
oanda_chart("XPD_USD")
```

In RStudio, please switch to the plots plane to view the chart if not already in focus.

Note that the periods displayed on the chart will be fewer than the 'count' specified - using default cloud periods, the first 77 datapoints will be excluded. This is by design to ensure a full cloud is displayed (i.e. there are no missing values for any cloud lines at the start of the data). Please take this into account when setting the 'count' parameter.

On exit from the function, the ichimoku object underlying the chart will be returned (invisibly). This allows the data to be saved simply by assigning to an object.

```{r oandacs, eval=FALSE}
# To access the data, simply assign the return value to an object:
cloud <- oanda_chart("XPD_USD")
```

### `oanda_studio()`

Create an interactive R Shiny session for working with real-time Ichimoku cloud charts. Provides a live analysis environment where parameters may be set interactively as required. The cursor infotip provides ready access to the data directly from the chart.

As all parameters can be set interactively in-app, `oanda_studio()` may be called without specifying any arguments. Otherwise, parameters may be set beforehand in the same way as `oanda_chart()`.

```{r oandas, eval=FALSE}
oanda_studio()
```
![](oanda-studio.jpg)

The following additional parameters can be used to customise the behaviour of the Shiny environment:

- `new.process` [default FALSE] if TRUE, will start the shiny session in a new R process, unblocking the current process and allowing continued use of the R console.
- `...` additional arguments passed to `ichimoku()` for calculating the ichimoku cloud, `autoplot()` to set chart parameters, or the 'options' argument of `shiny::shinyApp()`
- `launch.browser` [default TRUE] If TRUE, the system’s default web browser will be launched automatically after the app is started. The value of this argument can also be a function to call with the application’s URL. To use the default Shiny viewer in RStudio, please specify `getOption("shiny.launch.browser")`

#### Downloading Data

The ichimoku object underlying the live cloud chart can be saved by selecting the Data Archive button. 

This button uses `archive()` to save the ichimoku object to disk. The filename will be of the form: `instrument_granularity_price.rda`, e.g. `SUGAR_USD_D_A.rda`. If confirmed, the file is saved to the browser's default download location. Note that files with the same name are not overwritten but instead the filename is made unique.

To read back the file, use `archive()`:

```{r archive, eval=FALSE}
# Supply the quoted file path / name, for example:
cloud <- archive("~/Downloads/SUGAR_USD_D_A.rda")

# Or alternatively, choose the saved file interactively using a system dialog:
cloud <- archive()
```

### `oanda_stream()`

Connect to the OANDA fxTrade streaming API and stream a list of prices generated by OANDA.

The arguments are as follows:

- `instrument` the instrument to stream data for
- `display` [default 7L] specify an integer to customise the number of rows to display in the console at any one time
- `limit` (optional) specify a time in minutes by which to limit the streaming session. The session will end with data returned automatically after the specified time has elapsed

The 'server' and 'apikey' arguments are also available if required.

```{r oandastream, eval=FALSE}
# Streaming session will end with data automatically returned after 15 mins as set by 'limit':
data <- oanda_stream("UK10YB_GBP", limit = 15)
#> Streaming data... Press 'Esc' to return
#>    type                           time bid.price b.liquidity ask.price a.liquidity closeout.b closeout.a
#> 1 PRICE 2021-12-10T10:21:05.102768669Z   128.057       10000   128.087       10000    128.057    128.087
#> 2 PRICE 2021-12-10T10:21:54.853095391Z   128.057       10000   128.097       10000    128.057    128.097
#> 3 PRICE 2021-12-10T10:21:56.678923090Z   128.067       10000   128.097       10000    128.067    128.097
#> 4 PRICE 2021-12-10T10:21:58.959780877Z   128.057       10000   128.087       10000    128.057    128.087
#> 5 PRICE 2021-12-10T10:21:59.001234626Z   128.067       10000   128.097       10000    128.067    128.097
#> 6 PRICE 2021-12-10T10:22:01.827068694Z   128.067       10000   128.097       10000    128.067    128.097
#> 7 PRICE 2021-12-10T10:22:05.130294655Z   128.067       10000   128.097       10000    128.067    128.097
#>      status tradable instrument
#> 1 tradeable     TRUE UK10YB_GBP
#> 2 tradeable     TRUE UK10YB_GBP
#> 3 tradeable     TRUE UK10YB_GBP
#> 4 tradeable     TRUE UK10YB_GBP
#> 5 tradeable     TRUE UK10YB_GBP
#> 6 tradeable     TRUE UK10YB_GBP
#> 7 tradeable     TRUE UK10YB_GBP
```

Use the 'Esc' key to stop the stream and return the session data. Please remember to assign the return value to an object if you wish to retain the data.

All returned times are in UTC. 'b' and 'a' used in column headings are abbreviations to denote 'bid' and 'ask' respectively.

Note: only messages of type 'PRICE' are processed. Messages of type 'HEARTBEAT' consisting of only a timestamp are discarded.

The following should be noted from the streaming API documentation:

 - Pricing stream does not include every single price created for the Account
 - At most 4 prices are sent per second (every 250 milliseconds) for each instrument
 - If more than one price is created during the 250 millisecond window, only the price in effect at the end of the window is sent
 - This means that during periods of rapid price movement, not every price is sent
 - Pricing windows for different connections to the stream are not all aligned in the same way (e.g. to the top of the second)
 - This means that during periods of rapid price movement, different prices may be observed depending on the alignment for the connection

### `oanda_quote()`

A convenience function that outputs to the console the latest one-line price quote for an instrument.

The output format is as follows: instrument, timestamp, daily open, high, low and last prices, daily percentage change (from the open), and the pricing component (M for mid, B for bid, A for ask).

```{r oandaq, eval = FALSE}
oanda_quote("USD_JPY")
#> USD_JPY 2021-10-05 16:29:44 open: 110.931  high: 111.564  low: 110.871  last: 111.398  %chg: 0.421 M
```

### `oanda_view()`

Prints a snapshot overview of the selected market, showing the relative performance of all constituents.

The available markets are : 'allfx' for all available currencies, 'bonds' for government bonds, 'commodities' for commodities, 'fx' for major currency pairs, 'metals' for metals and 'stocks' for global stock markets. As partial matching is enabled, it is possible to type just the first letter e.g. 'c' for commodities.

The first retrieved timestamp and the pricing component are printed, followed by the dataframe showing similar data to `oanda_quote()` for all instruments in the selected market. The data is ordered by the daily percentage change, from the most positive to the most negative.

```{r oandav, eval = FALSE}
oanda_view()
Enter market [a]llfx [b]onds [c]ommodities [f]x [m]etals [s]tocks: c
#> Retrieving commodities [..........]
#> 2021-12-11 01:58:21 / M
#>                  open      high        low       last    %chg
#> NATGAS_USD    3.76200    3.9260    3.72400    3.85200  2.3923
#> BCO_USD      74.52600   76.2310   74.32600   75.88000  1.8168
#> WTICO_USD    70.91200   72.5540   70.55400   72.19000  1.8022
#> WHEAT_USD     7.67200    7.7710    7.57100    7.72700  0.7169
#> XPT_USD     930.20200  939.6000  924.29400  936.43800  0.6704
#> SOYBN_USD    12.63500   12.7580   12.58800   12.67800  0.3403
#> SUGAR_USD     0.19274    0.1948    0.19176    0.19334  0.3113
#> CORN_USD      5.89800    5.9410    5.86800    5.90200  0.0678
#> XCU_USD       4.30292    4.3479    4.26536    4.28361 -0.4488
#> XPD_USD    1805.14800 1815.1260 1729.61100 1752.81200 -2.8993
```

### `oanda_orders()` / `oanda_positions()`

Provides a summary of the aggregate orders/positions held by OANDA fxTrade clients at each price level.

'instrument' is a required argument. The latest order/position book is retrieved unless the optional argument 'time' is used to specify a time for which to retrieve the order/position book.

The data is returned as a dataframe, with parameters saved as attributes which can be viewed with `look()`. A chart showing the percentage long and short orders/positions at each price level is output to the graphical device.

Please note that this feature has been implemented by OANDA only for certain major currency pairs and should be considered experimental.

Note also that for the order book, only the interquartile range of order levels is charted as some orders are placed very far from the market price. The returned dataframe contains the full order book nevertheless.

## Available Instruments

The list of financial instruments available for your account may be retrieved by `oanda_instruments()`. The available instruments are also automatically populated as an input in `oanda_studio()`.

The list below serves as a reference only and may differ from those actually available for your account type and/or country/region.

```{r oandai, eval=FALSE}
oanda_instruments()
```
```{r ins, echo=FALSE}
print(ichimoku:::.oanda_instruments)
```

Note: the above table is saved as internal package data and used as a fallback if the API call fails. In such a case, a warning is issued once per session as subsequent calls will return the cached list.

## Caching Implementation

The package retrieves the following once only during a session (the first time they are used) and caches the variables for further use:

- OANDA fxTrade API key
- OANDA fxTrade account associated with an fxTrade API key
- OANDA list of available instruments

If for any reason these become invalid or outdated, please re-load the package (or restart your R session) to enable these variables to be refreshed.

Calling `oanda_switch()` will also clear all cached variables.

## References

‘OANDA’ and ‘fxTrade’ are trademarks owned by OANDA Corporation, an entity unaffiliated with the ichimoku package.

OANDA fxTrade API developer website: <https://developer.oanda.com/>.

Gao, C. (2021), *ichimoku: Visualization and Tools for Ichimoku Kinko Hyo Strategies*. R package version 1.2.5, <https://CRAN.R-project.org/package=ichimoku>.

---
